<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026新年 | 灵魂连接</title>
    <style>
        :root { --primary: #020205; --accent: #00f2fe; --gold: #fccb90; --glass: rgba(255, 255, 255, 0.05); }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: var(--primary); color: white; font-family: sans-serif; overflow: hidden; }
        #fwCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        .ui-wrapper { position: relative; z-index: 10; height: 100vh; display: flex; align-items: center; justify-content: center; pointer-events: none; }
        .glass-card { background: var(--glass); backdrop-filter: blur(25px); padding: 2rem; border-radius: 30px; border: 1px solid rgba(255, 255, 255, 0.1); width: 350px; text-align: center; pointer-events: auto; box-shadow: 0 25px 50px rgba(0,0,0,0.6); }
        h1 { font-weight: 200; letter-spacing: 5px; margin-bottom: 20px; background: linear-gradient(135deg, #fff, var(--gold)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .tab-group { display: flex; background: rgba(0,0,0,0.2); padding: 4px; border-radius: 15px; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 10px; border-radius: 12px; border: none; background: transparent; color: white; cursor: pointer; transition: 0.3s; }
        .tab-btn.active { background: var(--accent); color: #000; font-weight: bold; }
        input, textarea { width: 100%; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 10px; color: white; padding: 12px; margin: 5px 0; box-sizing: border-box; outline: none; }
        .btn-main { width: 100%; background: linear-gradient(45deg, var(--accent), #4facfe); color: #000; border: none; padding: 12px; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        #resultBox { margin-top: 15px; max-height: 150px; overflow-y: auto; text-align: left; }
        .msg-item { border-left: 2px solid var(--accent); padding-left: 10px; margin: 10px 0; color: var(--gold); font-style: italic; }
    </style>
</head>
<body>

<canvas id="fwCanvas"></canvas>
<audio id="bgMusic" loop><source src="Time To Love - October.flac" type="audio/flac"></audio>

<div class="ui-wrapper">
    <div class="glass-card">
        <h1>2026</h1>
        <div class="tab-group">
            <button class="tab-btn active" onclick="switchTab('write')">许愿</button>
            <button class="tab-btn" onclick="switchTab('check')">阅读愿望</button>
        </div>

        <div id="panel-write">
            <input type="text" id="toName" placeholder="收信人姓名">
            <input type="text" id="question" placeholder="设置密保问题 (如：我的猫叫什么？)">
            <input type="text" id="answer" placeholder="设置正确答案">
            <textarea id="message" rows="3" placeholder="写下你的私密心愿..."></textarea>
            <button class="btn-main" onclick="sendWish()">锁定并发送 ✨</button>
        </div>

        <div id="panel-check" style="display:none;">
            <div id="check-step1">
                <input type="text" id="myName" placeholder="输入你的姓名">
                <button class="btn-main" onclick="fetchQuestion()">寻找我的愿望 ✉️</button>
            </div>
            <div id="check-step2" style="display:none;">
                <p id="displayQuestion" style="color: var(--accent); font-size: 0.9rem;"></p>
                <input type="text" id="myAnswer" placeholder="输入你的答案">
                <button class="btn-main" onclick="verifyAndRead()">验证并开启</button>
            </div>
            <div id="resultBox"></div>
        </div>
    </div>
</div>

<script>
    function switchTab(tab) {
        document.getElementById('panel-write').style.display = tab === 'write' ? 'block' : 'none';
        document.getElementById('panel-check').style.display = tab === 'check' ? 'block' : 'none';
        const btns = document.querySelectorAll('.tab-btn');
        btns[0].classList.toggle('active', tab === 'write');
        btns[1].classList.toggle('active', tab === 'check');
    }

    async function sendWish() {
        const data = {
            to: document.getElementById('toName').value.trim(),
            question: document.getElementById('question').value.trim(),
            answer: document.getElementById('answer').value.trim(),
            msg: document.getElementById('message').value.trim()
        };
        if(!data.to || !data.msg || !data.question || !data.answer) return alert("请完整填写所有信息！");
        
        try {
            const res = await fetch('/api/wish', { method: 'POST', body: JSON.stringify(data) });
            if(res.ok) { alert("愿望已成功封存！"); location.reload(); }
            else { alert("发送失败，请检查 KV 绑定。"); }
        } catch(e) { alert("网络错误"); }
    }

    let currentName = "";
    async function fetchQuestion() {
        currentName = document.getElementById('myName').value.trim();
        if(!currentName) return;
        const res = await fetch(`/api/wish?name=${encodeURIComponent(currentName)}&type=question`);
        if(res.ok) {
            const data = await res.json();
            document.getElementById('displayQuestion').innerText = "问题：" + data.question;
            document.getElementById('check-step1').style.display = 'none';
            document.getElementById('check-step2').style.display = 'block';
        } else { alert("没找到发给你的愿望。"); }
    }

    async function verifyAndRead() {
        const answer = document.getElementById('myAnswer').value.trim();
        const res = await fetch(`/api/wish?name=${encodeURIComponent(currentName)}&answer=${encodeURIComponent(answer)}&type=verify`);
        const data = await res.json();
        if(data.success) {
            document.getElementById('check-step2').style.display = 'none';
            document.getElementById('resultBox').innerHTML = data.messages.map(m => `<div class="msg-item">"${m}"</div>`).join('');
        } else { alert("答案错误，请重试。"); }
    }

    // 烟花动画
    const canvas = document.getElementById('fwCanvas');
    const ctx = canvas.getContext('2d');
    let particles = [];
    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.addEventListener('resize', resize); resize();
    window.addEventListener('mousedown', (e) => {
        if(e.target.closest('.glass-card')) return;
        const color = `hsl(${Math.random() * 360}, 80%, 70%)`;
        for(let i=0; i<30; i++) {
            particles.push({
                x: e.clientX, y: e.clientY,
                vx: (Math.random()-0.5)*10, vy: (Math.random()-0.5)*10,
                color, alpha: 1
            });
        }
        document.getElementById('bgMusic').play().catch(()=>{});
    });
    function animate() {
        ctx.fillStyle = 'rgba(2, 2, 5, 0.2)'; ctx.fillRect(0, 0, canvas.width, canvas.height);
        particles.forEach((p, i) => {
            p.x += p.vx; p.y += p.vy; p.alpha -= 0.01;
            ctx.globalAlpha = p.alpha; ctx.fillStyle = p.color;
            ctx.beginPath(); ctx.arc(p.x, p.y, 2, 0, Math.PI*2); ctx.fill();
            if(p.alpha <= 0) particles.splice(i, 1);
        });
        requestAnimationFrame(animate);
    }
    animate();
</script>
</body>
</html>
