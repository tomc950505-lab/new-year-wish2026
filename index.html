<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026新年 | 灵魂连接</title>
    <style>
        :root { --primary: #020205; --accent: #00f2fe; --gold: #fccb90; --glass: rgba(255, 255, 255, 0.05); }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: var(--primary); color: white; font-family: 'Inter', sans-serif; overflow: hidden; }
        #fwCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; pointer-events: none; }
        .ui-wrapper { position: relative; z-index: 10; height: 100vh; display: flex; align-items: center; justify-content: center; pointer-events: none; }
        .glass-card { background: var(--glass); backdrop-filter: blur(25px); padding: 2.5rem; border-radius: 40px; border: 1px solid rgba(255, 255, 255, 0.1); width: 400px; text-align: center; pointer-events: auto; box-shadow: 0 25px 50px rgba(0,0,0,0.6); }
        h1 { font-weight: 200; letter-spacing: 8px; margin: 0 0 20px; font-size: 2.5rem; background: linear-gradient(135deg, #fff, var(--gold)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .tab-group { display: flex; background: rgba(0,0,0,0.2); padding: 4px; border-radius: 20px; margin-bottom: 20px; }
        .tab-btn { flex: 1; padding: 8px; border-radius: 16px; border: none; background: transparent; color: white; cursor: pointer; transition: 0.3s; font-size: 0.8rem; }
        .tab-btn.active { background: var(--accent); color: #000; font-weight: bold; }
        input, textarea { width: 100%; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; color: white; padding: 12px; margin: 6px 0; outline: none; font-size: 0.85rem; }
        input:focus { border-color: var(--accent); background: rgba(0, 242, 254, 0.05); }
        .btn-main { width: 100%; background: linear-gradient(45deg, var(--accent), #4facfe); color: #000; border: none; padding: 12px; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .music-ctrl { position: fixed; top: 30px; right: 30px; z-index: 100; pointer-events: auto; cursor: pointer; }
        .disc { width: 45px; height: 45px; border-radius: 50%; border: 1px solid var(--accent); display: flex; align-items: center; justify-content: center; background: #000; }
        .disc.playing { animation: spin 4s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        #resultBox { margin-top: 15px; max-height: 200px; overflow-y: auto; text-align: left; font-size: 0.9rem; padding-right: 5px; }
        .msg-item { border-left: 2px solid var(--accent); padding-left: 10px; margin: 15px 0; font-style: italic; color: var(--gold); line-height: 1.4; }
    </style>
</head>
<body>

<canvas id="fwCanvas"></canvas>
<audio id="bgMusic" loop><source src="Time To Love - October.flac" type="audio/flac"></audio>

<div class="music-ctrl" onclick="toggleMusic()">
    <div class="disc" id="disc"><svg width="18" height="18" fill="white" viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg></div>
</div>

<div class="ui-wrapper">
    <div class="glass-card">
        <h1>2026</h1>
        <div class="tab-group">
            <button class="tab-btn active" id="btn-write" onclick="switchTab('write')">写下愿望</button>
            <button class="tab-btn" id="btn-check" onclick="switchTab('check')">阅读愿望</button>
        </div>

        <div id="panel-write">
            <input type="text" id="toName" placeholder="收信人姓名">
            <input type="text" id="question" placeholder="设置密保问题 (如：我最喜欢的零食)">
            <input type="text" id="answer" placeholder="设置正确答案">
            <textarea id="message" rows="3" placeholder="你的私密留言..."></textarea>
            <button class="btn-main" onclick="sendWish()">锁定并发送 ✨</button>
        </div>

        <div id="panel-check" style="display:none;">
            <div id="check-step1">
                <input type="text" id="myName" placeholder="输入你的姓名">
                <button class="btn-main" onclick="fetchQuestion()">寻找我的愿望 ✉️</button>
            </div>
            <div id="check-step2" style="display:none;">
                <p id="displayQuestion" style="color: var(--accent); font-size: 0.9rem; margin-bottom: 10px;"></p>
                <input type="text" id="myAnswer" placeholder="输入答案">
                <button class="btn-main" onclick="verifyAndRead()">验证并开启</button>
            </div>
            <div id="resultBox"></div>
        </div>
    </div>
</div>

<script>
    function switchTab(tab) {
        document.getElementById('panel-write').style.display = tab === 'write' ? 'block' : 'none';
        document.getElementById('panel-check').style.display = tab === 'check' ? 'block' : 'none';
        document.getElementById('btn-write').classList.toggle('active', tab === 'write');
        document.getElementById('btn-check').classList.toggle('active', tab === 'check');
    }

    async function sendWish() {
        const data = {
            to: document.getElementById('toName').value.trim(),
            question: document.getElementById('question').value.trim(),
            answer: document.getElementById('answer').value.trim(),
            msg: document.getElementById('message').value.trim()
        };
        if(!data.to || !data.msg || !data.question || !data.answer) return alert("请填写完整信息！");
        
        try {
            const res = await fetch('/api/wish', { method: 'POST', body: JSON.stringify(data) });
            if(res.ok) { alert("愿望已封存并发往2026！"); location.reload(); }
        } catch(e) { alert("发送失败，请检查网络或配置。"); }
    }

    let currentTargetName = "";
    async function fetchQuestion() {
        currentTargetName = document.getElementById('myName').value.trim();
        if(!currentTargetName) return;
        try {
            const res = await fetch(`/api/wish?name=${encodeURIComponent(currentTargetName)}&type=question`);
            const data = await res.json();
            if(data.question) {
                document.getElementById('displayQuestion').innerText = "问题：" + data.question;
                document.getElementById('check-step1').style.display = 'none';
                document.getElementById('check-step2').style.display = 'block';
            } else { alert("未找到属于你的愿望。"); }
        } catch(e) { alert("查询失败。"); }
    }

    async function verifyAndRead() {
        const answer = document.getElementById('myAnswer').value.trim();
        try {
            const res = await fetch(`/api/wish?name=${encodeURIComponent(currentTargetName)}&answer=${encodeURIComponent(answer)}&type=verify`);
            const data = await res.json();
            if(data.success) {
                document.getElementById('check-step2').style.display = 'none';
                // 遍历显示所有信件
                document.getElementById('resultBox').innerHTML = data.messages.map(m => `<div class="msg-item">"${m}"</div>`).join('');
            } else { alert("答案错误，请重试。"); }
        } catch(e) { alert("验证失败。"); }
    }

    // 烟花特效代码
    const canvas = document.getElementById('fwCanvas');
    const ctx = canvas.getContext('2d');
    let particles = [];
    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.addEventListener('resize', resize); resize();
    window.addEventListener('mousedown', (e) => {
        if(e.target.closest('.glass-card')) return;
        const color = `hsl(${Math.random() * 360}, 80%, 70%)`;
        for(let i=0; i<40; i++) {
            const angle = Math.random() * Math.PI * 2;
            const speed = Math.random() * 5 + 1;
            particles.push({ x: e.clientX, y: e.clientY, vx: Math.cos(angle)*speed, vy: Math.sin(angle)*speed, color, alpha: 1 });
        }
        if(document.getElementById('bgMusic').paused) toggleMusic();
    });
    function animate() {
        ctx.fillStyle = 'rgba(2, 2, 5, 0.2)'; ctx.fillRect(0, 0, canvas.width, canvas.height);
        particles.forEach((p, i) => {
            p.vx *= 0.98; p.vy *= 0.98; p.vy += 0.05; p.x += p.vx; p.y += p.vy; p.alpha -= 0.015;
            ctx.globalAlpha = p.alpha; ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(p.x, p.y, 1.5, 0, Math.PI*2); ctx.fill();
            if(p.alpha <= 0) particles.splice(i, 1);
        });
        requestAnimationFrame(animate);
    }
    animate();

    function toggleMusic() {
        const a = document.getElementById('bgMusic');
        const d = document.getElementById('disc');
        if(a.paused) { a.play(); d.classList.add('playing'); } else { a.pause(); d.classList.remove('playing'); }
    }
</script>
</body>
</html>
