<script>
    // ... 保留 switchTab 和 sendWish 函数 ...

    let selectedWishId = ""; // 当前选中的信件ID

    // 1. 获取愿望列表
    async function fetchQuestion() {
        const name = document.getElementById('myName').value.trim();
        if(!name) return;
        
        const res = await fetch(`/api/wish?name=${encodeURIComponent(name)}&type=list`);
        const wishes = await res.json();
        
        const resultBox = document.getElementById('resultBox');
        if(wishes.length === 0) {
            resultBox.innerHTML = "<p>没有找到属于你的愿望。</p>";
            return;
        }

        // 清空并显示问题列表
        resultBox.innerHTML = '<p style="color:var(--accent); margin-bottom:10px;">点击以下问题进行解锁：</p>';
        wishes.forEach((w, index) => {
            const btn = document.createElement('div');
            btn.className = 'msg-item';
            btn.style.cursor = 'pointer';
            btn.style.border = '1px solid var(--accent)';
            btn.style.padding = '10px';
            btn.innerText = `信件 ${index + 1}: ${w.question}`;
            btn.onclick = () => {
                selectedWishId = w.id;
                document.getElementById('displayQuestion').innerText = "问题: " + w.question;
                document.getElementById('check-step1').style.display = 'none';
                document.getElementById('check-step2').style.display = 'block';
                resultBox.innerHTML = ""; // 隐藏列表进入验证
            };
            resultBox.appendChild(btn);
        });
    }

    // 2. 验证并开启单封信件
    async function verifyAndRead() {
        const answer = document.getElementById('myAnswer').value.trim();
        const name = document.getElementById('myName').value.trim();
        
        const res = await fetch(`/api/wish?name=${encodeURIComponent(name)}&id=${encodeURIComponent(selectedWishId)}&answer=${encodeURIComponent(answer)}&type=verify`);
        const data = await res.json();
        
        if(data.success) {
            document.getElementById('check-step2').style.display = 'none';
            // 显示内容，并提供返回按钮继续开启其他信件
            document.getElementById('resultBox').innerHTML = `
                <div class="msg-item" style="color:var(--gold); border-left:3px solid var(--gold);">"${data.message}"</div>
                <button class="btn-main" onclick="location.reload()" style="background:var(--gold)">返回查看其他信件</button>
            `;
        } else {
            alert("答案错误！");
        }
    }
    
    // ... 保留烟花和音乐逻辑 ...
</script>
